if (F)
    rm(list = ls())

eps = 1e-8
# wg. rtklib/estpos()

rawH = c(0.60385836346334187, -0.31288954788551221, -0.73311336619882617, 1, 0, 0, 0, 0.19895493558965865, 0.5600692660926273, -0.80420106365446975, 1, 0, 0, 0, 0.48837538579350609, -0.54172629827265184, -0.68412140758117923, 1, 0, 0, 0, -0.73235109443767199, 0.1106966541431824, -0.67186912805802357, 1, 0, 0, 0, -0.31988884853144972, -0.46798264447512006, -0.82381027491485948, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 6.9533477229218511e-310, 6.9533477229360802e-310, 6.9533477229503093e-310, 6.9533477229645384e-310, 6.9533477229787675e-310, 6.9533477229929966e-310, 6.9533477230072257e-310)
H = matrix(rawH, 7, 9)

nv = 8

H = H[,1:nv] 
y = t(t(c(-22089615.658630192, -22734351.563631907, -22613920.385727327, -26647819.602667764, -26747482.489814311, 0, 0, 0, 0)))
y = y[1:nv]

var = c(6.104380165289256, 6.104380165289256, 6.104380165289256, 6.104380165289256, 6.104380165289256, 0.01, 0.01, 0.01, 1.6828652443341117e-284)
var = var[1:nv]
if (F)
    var = var * 100
W = diag(1 / sqrt(var))

# H jest transposed
x1 = solve(H %*% W %*% t(H)) %*% H %*% W %*% y

y2 = y / sqrt(var)

H2 = H / sqrt(matrix(rep(var, 7), 7, 8, byrow = T))

# x=(A*A')^-1*A*y
x2 = solve(H2 %*% t(H2)) %*% H2 %*% y2
x3 = solve(H %*% t(H)) %*% H %*% y 

refX = t(t(c(4221924.6686022431, 1653019.6219099462, 5871326.3603553772, -19788024.912757874, 0, 0, 0)))

max(abs(x1 - refX))
max(abs(x2 - refX))
max(abs(x3 - refX))

max(abs(x1 - x3))
max(abs(x1 - x2))

all(abs(W %*% y - t(t(y2))) < eps)


# oo...
all(abs(H %*% W - H2) < eps)

(H %*% W %*% t(H)) - H2 %*% t(H2)

# czyli nie jest to dobrze zaimplementowane...
all(abs((H %*% W %*% t(H %*% W)) - H2 %*% t(H2)) < eps)

max(abs((H %*% W %*% t(H %*% W)) - H %*% W %*% t(H)))

all(abs((H2 %*% t(H2 %*% solve(W))) - H %*% W %*% t(H)) < eps)
all(abs((H2 %*% t(H)) - H %*% W %*% t(H)) < eps)
all(diag(sqrt(var)) == solve(W))

stopifnot(abs((H2 %*% t(H2 %*% diag(sqrt(var)))) - H %*% W %*% t(H)) <eps)
stopifnot(abs(H2 %*% solve(W) - H) < eps)

# x4 = solve(H2 %*% t(H)) %*% H2 %*% y2 
x4 = solve(H %*% W %*% t(H)) %*% H %*% W %*% y
x4 = solve(H2 %*% t(H)) %*% H %*% W %*% y
x4 = solve(H2 %*% t(H)) %*% H2 %*% y
max(abs(x4 - x1))








